
# Below I'll write options that need to be configured for distributed monitoring.
# This means that we have one Central server that send notifications, collects passive service checks, but do not perform the last actively.
# Distributed servers actually perform all service checks and then send passive checks to the central server.

1. Installation packages:

apt-get install icinga nsca-client nagios-nrpe-server nagios-nrpe-plugin

2. Edit /etc/icinga/icinga.cfg and change below parameters as shown:

sed -i 's/check_external_commands=0/check_external_commands=1/g' /etc/icinga/icinga.cfg
sed -i 's/enable_notifications=1/enable_notifications=0/g' /etc/icinga/icinga.cfg
sed -i 's/obsess_over_services=0/obsess_over_services=1/g' /etc/icinga/icinga.cfg
sed -i 's/#ocsp_command=somecommand/ocsp_command=submit_check_result/g' /etc/icinga/icinga.cfg


3. Now you need to edit default central hostname provided in this file:

cd /usr/share/icinga/plugins/eventhandlers/distributed-monitoring/
sed -i 's/icingahost/<YOUR-CENTRAL-SRV-HOSTNAME>/g' submit_check_result_via_nsca

4. Then you need to define your ocsp_command that you have used above:

vi /etc/icinga/commands.cfg // and put there this:

define command{
	command_name submit_check_result
	command_line	/usr/share/icinga/plugins/eventhandlers/distributed-monitoring/submit_check_result_via_nsca '$HOSTNAME$' '$SERVICEDESC$' $SERVICESTATEID$ '$SERVICEOUTPUT$'
}

5. Fix permissions for command folder and files:

dpkg-statoverride --update --add nagios www-data 2710 /var/lib/icinga/rw
dpkg-statoverride --update --add nagios nagios 751 /var/lib/icinga

6. Edit /etc/nagios/nrpe.cfg and fix this:

allowed_hosts=127.0.0.1, 192.168.56.11, 192.168.56.14
command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10
command[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20
command[check_disks]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10% -p /
command[check_procs]=/usr/lib/nagios/plugins/check_procs -w 5 -c 10 -s Z
command[check_total_procs]=/usr/lib/nagios/plugins/check_procs -w 150 -c 200

service nagios-nrpe-server restart

# NOTE! Do not forget to configure all service checks for your clients on distribution server.
# EOF


