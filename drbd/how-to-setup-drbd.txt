# This is tested on Debian 10, DRBD 9.5.0

# 1. Create your backend device, e.g. /dev/mapper/vg0-drbd-disk
lvcreate -L 1G -n drbd-disk vg0

# 2. Install DRBD
apt-get install drbd-utils -y

# 3. Start drbd.service
systemctl start drbd.service

# 4. Use sample configuration for your resouce r0:

resource r0 {
        protocol C;
        device /dev/drbd0;
        disk /dev/mapper/vg0-drbd--disk;
        disk {
            #on-io-error detach;
            #no-disk-flushes ;
            #no-disk-barrier;
            c-plan-ahead 0;
            c-fill-target 24M;
            c-min-rate 30M;
            c-max-rate 125M;
        }
        handlers {
            before-resync-target "/usr/lib/drbd/snapshot-resync-target-lvm.sh";
            after-resync-target "/usr/lib/drbd/unsnapshot-resync-target-lvm.sh";
        }
        meta-disk internal;
        net {
            verify-alg sha1;
            cram-hmac-alg sha1;
            shared-secret "<YOUR-PASSWORD-HERE>";
            max-buffers             36k;
            sndbuf-size            1024k;
            rcvbuf-size            2048k;
        }
        on panda {
            address 10.10.10.1:7788;
        }
        on panda2 {
            address 10.10.10.2:7788;
        }
}

# 5. Fix your network and firewall ports
# 6. Initialize your DRBD device ON BOTH NODES!:
drbdadm create-md r0

# 7. Bring your resources up ON BOTH NODES!:
drbdadm up r0

# 8. Now check /proc/drbd
cat /proc/drbd 

# you should see something like this:
version: 8.4.10 (api:1/proto:86-101)
srcversion: 983FCB77F30137D4E127B83 
 0: cs:SyncTarget ro:Secondary/Primary ds:Inconsistent/UpToDate C r-----
    ns:0 nr:25344 dw:25344 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1023164
	[>....................] sync'ed:  2.8% (1023164/1048508)K
	finish: 1:00:54 speed: 272 (264) want: 250 K/sec

# NOTE that initial sync is much SLOWER!

# 9. Now promote your primary node. 
# NOTE: this is valid for newly created and empty devices.
# If your have existing data, then it's much more important WHO
# will be your SOURCE. Make it the wrong one and you'll loose your data!
 drbdadm primary --force

# 10. Now you can format your disk:
mke2fs -t ext4 /dev/drbd0

# 11. Mount it and use it.
mount /dev/drbd0 /mnt

# 12. Last, but not lease is to play very well and test you PERFORMANCE!
# GOOD LUCK!



















